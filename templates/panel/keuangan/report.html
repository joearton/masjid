{% extends "base/panel.html" %}
{% load i18n humanize %}

{% block extra_css %}
<style>
    .chart-card {
        border: 0;
        border-radius: 12px;
        overflow: hidden;
    }
    .chart-card .card-header {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
        font-size: 14px;
    }
    .stat-card {
        border: 0;
        border-radius: 12px;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
    }
    .table-report th {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        font-weight: 600;
    }
    .table-report td {
        font-size: 14px;
    }
    .year-selector .btn-check:checked + .btn {
        background-color: #0d6efd;
        color: #fff;
        border-color: #0d6efd;
    }
</style>
{% endblock %}

{% block panel_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="fw-bold mb-1"><i class="bi bi-bar-chart-line me-2 text-info"></i>{{ page_title }}</h4>
        <p class="text-muted mb-0 small">{% trans "Visualisasi dan ringkasan keuangan masjid" %}</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'keuangan:panel_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>{% trans "Transaksi" %}
        </a>
    </div>
</div>

<!-- Year Filter -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body py-2 px-3">
        <form method="get" class="d-flex align-items-center gap-3">
            <span class="text-muted small fw-semibold"><i class="bi bi-calendar3 me-1"></i>{% trans "Tahun:" %}</span>
            <select name="tahun" class="form-select form-select-sm" style="width:auto;" onchange="this.form.submit()">
                {% for y in year_list %}
                <option value="{{ y }}" {% if selected_tahun == y %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </form>
    </div>
</div>

<!-- Summary Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card stat-card shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center gap-3">
                    <div class="rounded-3 bg-success-subtle d-flex align-items-center justify-content-center" style="width:52px;height:52px;">
                        <i class="bi bi-arrow-down-circle text-success fs-3"></i>
                    </div>
                    <div>
                        <div class="text-muted small">{% trans "Total Pemasukan" %} {{ selected_tahun }}</div>
                        <div class="fs-4 fw-bold text-success">Rp {{ total_masuk|intcomma }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center gap-3">
                    <div class="rounded-3 bg-danger-subtle d-flex align-items-center justify-content-center" style="width:52px;height:52px;">
                        <i class="bi bi-arrow-up-circle text-danger fs-3"></i>
                    </div>
                    <div>
                        <div class="text-muted small">{% trans "Total Pengeluaran" %} {{ selected_tahun }}</div>
                        <div class="fs-4 fw-bold text-danger">Rp {{ total_keluar|intcomma }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center gap-3">
                    <div class="rounded-3 bg-primary-subtle d-flex align-items-center justify-content-center" style="width:52px;height:52px;">
                        <i class="bi bi-wallet2 text-primary fs-3"></i>
                    </div>
                    <div>
                        <div class="text-muted small">{% trans "Saldo" %} {{ selected_tahun }}</div>
                        <div class="fs-4 fw-bold {% if saldo >= 0 %}text-primary{% else %}text-danger{% endif %}">Rp {{ saldo|intcomma }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <!-- Monthly Bar Chart -->
    <div class="col-lg-8">
        <div class="card chart-card shadow-sm">
            <div class="card-header py-3">
                <i class="bi bi-bar-chart me-2"></i>{% trans "Pemasukan vs Pengeluaran Bulanan" %} — {{ selected_tahun }}
            </div>
            <div class="card-body" style="height:360px;">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Doughnut Charts -->
    <div class="col-lg-4">
        <div class="card chart-card shadow-sm mb-4">
            <div class="card-header py-3">
                <i class="bi bi-pie-chart me-2 text-success"></i>{% trans "Kategori Pemasukan" %}
            </div>
            <div class="card-body d-flex justify-content-center" style="height:200px;">
                <canvas id="pemasukanDonut"></canvas>
            </div>
        </div>
        <div class="card chart-card shadow-sm">
            <div class="card-header py-3">
                <i class="bi bi-pie-chart me-2 text-danger"></i>{% trans "Kategori Pengeluaran" %}
            </div>
            <div class="card-body d-flex justify-content-center" style="height:200px;">
                <canvas id="pengeluaranDonut"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Trend Line Chart -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card chart-card shadow-sm">
            <div class="card-header py-3">
                <i class="bi bi-graph-up me-2 text-info"></i>{% trans "Tren Saldo Kumulatif" %} — {{ selected_tahun }}
            </div>
            <div class="card-body" style="height:280px;">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Monthly Detail Table -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white py-3 border-bottom">
        <h6 class="mb-0 fw-bold"><i class="bi bi-table me-2"></i>{% trans "Rincian Bulanan" %} — {{ selected_tahun }}</h6>
    </div>
    <div class="table-responsive">
        <table class="table table-hover table-report mb-0">
            <thead class="table-light">
                <tr>
                    <th>{% trans "Bulan" %}</th>
                    <th class="text-end">{% trans "Pemasukan" %}</th>
                    <th class="text-end">{% trans "Pengeluaran" %}</th>
                    <th class="text-end">{% trans "Selisih" %}</th>
                    <th class="text-end">{% trans "Saldo Kumulatif" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for row in monthly_detail %}
                <tr>
                    <td class="fw-semibold">{{ row.bulan }}</td>
                    <td class="text-end text-success">
                        {% if row.masuk > 0 %}Rp {{ row.masuk|floatformat:0|intcomma }}{% else %}<span class="text-muted">-</span>{% endif %}
                    </td>
                    <td class="text-end text-danger">
                        {% if row.keluar > 0 %}Rp {{ row.keluar|floatformat:0|intcomma }}{% else %}<span class="text-muted">-</span>{% endif %}
                    </td>
                    <td class="text-end fw-semibold {% if row.selisih >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {% if row.masuk > 0 or row.keluar > 0 %}Rp {{ row.selisih|floatformat:0|intcomma }}{% else %}<span class="text-muted">-</span>{% endif %}
                    </td>
                    <td class="text-end fw-bold {% if row.saldo >= 0 %}text-primary{% else %}text-danger{% endif %}">
                        {% if row.masuk > 0 or row.keluar > 0 %}Rp {{ row.saldo|floatformat:0|intcomma }}{% else %}<span class="text-muted">-</span>{% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot class="table-light">
                <tr class="fw-bold">
                    <td>{% trans "Total" %}</td>
                    <td class="text-end text-success">Rp {{ total_masuk|intcomma }}</td>
                    <td class="text-end text-danger">Rp {{ total_keluar|intcomma }}</td>
                    <td class="text-end {% if saldo >= 0 %}text-success{% else %}text-danger{% endif %}">Rp {{ saldo|intcomma }}</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
(function() {
    const labels = {{ chart_labels|safe }};
    const masukData = {{ chart_masuk|safe }};
    const keluarData = {{ chart_keluar|safe }};

    // Color palette
    const successColor = 'rgba(25, 135, 84, 0.85)';
    const dangerColor = 'rgba(220, 53, 69, 0.85)';
    const primaryColor = 'rgba(13, 110, 253, 0.85)';

    // Helper: Format Rupiah
    function formatRp(val) {
        return 'Rp ' + new Intl.NumberFormat('id-ID').format(val);
    }

    // ─── Monthly Bar Chart ───
    new Chart(document.getElementById('monthlyChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Pemasukan',
                    data: masukData,
                    backgroundColor: successColor,
                    borderRadius: 6,
                    borderSkipped: false,
                },
                {
                    label: 'Pengeluaran',
                    data: keluarData,
                    backgroundColor: dangerColor,
                    borderRadius: 6,
                    borderSkipped: false,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', labels: { usePointStyle: true, padding: 16 } },
                tooltip: {
                    callbacks: { label: function(ctx) { return ctx.dataset.label + ': ' + formatRp(ctx.raw); } }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: function(v) { return formatRp(v); } },
                    grid: { color: 'rgba(0,0,0,0.05)' }
                },
                x: { grid: { display: false } }
            }
        }
    });

    // ─── Pemasukan Doughnut ───
    const pemasukanLabels = {{ kat_masuk_labels|safe }};
    const pemasukanData = {{ kat_masuk_data|safe }};
    const donutColors = [
        '#198754', '#20c997', '#0dcaf0', '#0d6efd', '#6610f2',
        '#d63384', '#fd7e14', '#ffc107', '#6f42c1', '#adb5bd'
    ];

    if (pemasukanData.length > 0) {
        new Chart(document.getElementById('pemasukanDonut'), {
            type: 'doughnut',
            data: {
                labels: pemasukanLabels,
                datasets: [{
                    data: pemasukanData,
                    backgroundColor: donutColors.slice(0, pemasukanData.length),
                    borderWidth: 2,
                    borderColor: '#fff',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { font: { size: 11 }, padding: 8, usePointStyle: true } },
                    tooltip: {
                        callbacks: { label: function(ctx) { return ctx.label + ': ' + formatRp(ctx.raw); } }
                    }
                },
                cutout: '55%',
            }
        });
    } else {
        document.getElementById('pemasukanDonut').parentElement.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 text-muted small">Belum ada data</div>';
    }

    // ─── Pengeluaran Doughnut ───
    const pengeluaranLabels = {{ kat_keluar_labels|safe }};
    const pengeluaranData = {{ kat_keluar_data|safe }};
    const donutColors2 = [
        '#dc3545', '#fd7e14', '#ffc107', '#e91e83', '#6f42c1',
        '#0dcaf0', '#198754', '#0d6efd', '#adb5bd', '#6610f2'
    ];

    if (pengeluaranData.length > 0) {
        new Chart(document.getElementById('pengeluaranDonut'), {
            type: 'doughnut',
            data: {
                labels: pengeluaranLabels,
                datasets: [{
                    data: pengeluaranData,
                    backgroundColor: donutColors2.slice(0, pengeluaranData.length),
                    borderWidth: 2,
                    borderColor: '#fff',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { font: { size: 11 }, padding: 8, usePointStyle: true } },
                    tooltip: {
                        callbacks: { label: function(ctx) { return ctx.label + ': ' + formatRp(ctx.raw); } }
                    }
                },
                cutout: '55%',
            }
        });
    } else {
        document.getElementById('pengeluaranDonut').parentElement.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 text-muted small">Belum ada data</div>';
    }

    // ─── Trend Line Chart (cumulative saldo) ───
    const cumulativeSaldo = [];
    let running = 0;
    for (let i = 0; i < masukData.length; i++) {
        running += masukData[i] - keluarData[i];
        cumulativeSaldo.push(running);
    }

    new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Pemasukan',
                    data: masukData,
                    borderColor: '#198754',
                    backgroundColor: 'rgba(25, 135, 84, 0.08)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                },
                {
                    label: 'Pengeluaran',
                    data: keluarData,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.08)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                },
                {
                    label: 'Saldo Kumulatif',
                    data: cumulativeSaldo,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.08)',
                    fill: true,
                    borderWidth: 3,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    borderDash: [6, 3],
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', labels: { usePointStyle: true, padding: 16 } },
                tooltip: {
                    callbacks: { label: function(ctx) { return ctx.dataset.label + ': ' + formatRp(ctx.raw); } }
                }
            },
            scales: {
                y: {
                    ticks: { callback: function(v) { return formatRp(v); } },
                    grid: { color: 'rgba(0,0,0,0.05)' }
                },
                x: { grid: { display: false } }
            }
        }
    });
})();
</script>
{% endblock %}
