{% load static hijri_tags custom_filters %}
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Masjid - {{ profil.nama }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Orbitron:wght@600;800&family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        /* ============================================
           BASE VARIABLES & RESET
           ============================================ */
        :root {
            --primary: #1a6b3c;
            --accent: #f0a500;
            --bg-dark: #0f172a;
            --text-light: #f8fafc;
            --glass: rgba(0, 0, 0, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
            --gold: #ffc107;
            --gold-dark: #b4890b;
            --led-red: #ff3333;
            --dark-green: #011c0e;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ============================================
           BACKGROUND
           ============================================ */
        .bg-media {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            z-index: -1;
            filter: brightness(0.4);
        }

        /* ============================================
           HEADER
           ============================================ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 3rem;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            z-index: 10;
            flex-shrink: 0;
        }

        .masjid-info h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            color: #fff;
        }

        .masjid-info p {
            margin: 0.2rem 0 0;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .clock-widget {
            text-align: right;
        }

        .clock-time {
            font-size: 3.5rem;
            font-weight: 700;
            line-height: 1;
            font-variant-numeric: tabular-nums;
            color: var(--accent);
        }

        .clock-date {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: 0.2rem;
        }

        .clock-hijri {
            font-size: 0.95rem;
            opacity: 0.75;
            margin-top: 0.15rem;
            font-style: italic;
        }

        /* ============================================
           CONTENT GRID (Default: Classic Layout)
           ============================================ */
        .content-grid {
            flex: 1;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 2rem;
            padding: 1rem 3rem 4rem;
            min-height: 0;
        }

        /* ============================================
           PRAYER LIST
           ============================================ */
        .prayer-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            justify-content: center;
        }

        .prayer-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .prayer-item.active {
            background: var(--primary);
            border-color: var(--accent);
            transform: scale(1.05) translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .prayer-name { font-size: 1.4rem; font-weight: 600; }
        .prayer-time { font-size: 1.6rem; font-weight: 700; color: var(--accent); }
        .prayer-item.active .prayer-time { color: #fff; }

        /* ============================================
           SLIDE CONTAINER
           ============================================ */
        .slide-container {
            position: relative;
            background: var(--glass);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .slide {
            display: none;
            width: 100%; height: 100%;
            animation: fadeIn 0.5s ease-in-out;
            padding: 2rem;
            box-sizing: border-box;
            flex-direction: column;
        }

        .slide.active { display: flex; }

        .slide-content-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }

        .slide-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--accent);
            border-bottom: 2px solid rgba(255,255,255,0.1);
            padding-bottom: 0.5rem;
            width: 100%;
            text-align: center;
        }

        .slide-text { font-size: 1.8rem; line-height: 1.6; }

        .slide-image img {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* ============================================
           RUNNING TEXT
           ============================================ */
        .running-text-container {
            background: #000;
            color: var(--accent);
            padding: 0.8rem 0;
            white-space: nowrap;
            overflow: hidden;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 100;
            border-top: 2px solid var(--primary);
            font-family: 'Courier New', monospace;
        }

        .running-text {
            display: inline-block;
            animation: marquee 30s linear infinite;
            font-size: 1.6rem;
            font-weight: 700;
        }

        @keyframes marquee {
            0% { transform: translateX(100vw); }
            100% { transform: translateX(-100%); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============================================
           SLIDE-SPECIFIC: List Items, Finance, etc.
           ============================================ */
        .list-item {
            background: rgba(255,255,255,0.05);
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 10px;
            display: flex;
            gap: 1rem;
            align-items: center;
            text-align: left;
            width: 100%;
        }
        .list-date {
            background: var(--primary);
            padding: 0.5rem;
            border-radius: 8px;
            text-align: center;
            min-width: 80px;
        }
        .list-date .day { font-size: 1.5rem; font-weight: bold; line-height: 1; }
        .list-date .month { font-size: 0.8rem; text-transform: uppercase; }

        .finance-box {
            background: linear-gradient(135deg, var(--primary), #0b4623);
            padding: 3rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .finance-amount {
            font-size: 5rem;
            font-weight: 800;
            color: #fff;
            margin: 1rem 0;
        }

        /* ============================================
           THEME OVERRIDES
           ============================================ */
        body.theme-blue {
            --primary: #0284c7;
            --accent: #38bdf8;
            --bg-dark: #082f49;
        }
        body.theme-dark {
            --primary: #334155;
            --accent: #94a3b8;
            --bg-dark: #020617;
        }
        body.theme-gold {
            --primary: #713f12;
            --accent: #fbbf24;
            --bg-dark: #1c1917;
        }
        body.theme-purple {
            --primary: #6d28d9;
            --accent: #c4b5fd;
            --bg-dark: #2e1065;
        }
        body.theme-nature {
            --primary: #3f6212;
            --accent: #bef264;
            --bg-dark: #0f1c05;
        }

        /* ============================================
           LAYOUT: Modern (Prayer at bottom)
           ============================================ */
        body.layout-modern .content-grid {
            grid-template-columns: 1fr;
            grid-template-rows: 1fr auto;
            gap: 1rem;
        }
        body.layout-modern .prayer-list {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.8rem;
            order: 2;
        }
        body.layout-modern .slide-container { order: 1; }
        body.layout-modern .prayer-item {
            flex-direction: column;
            text-align: center;
            padding: 0.8rem 0.5rem;
            justify-content: center;
        }
        body.layout-modern .prayer-item.active {
            transform: scale(1.05);
        }
        body.layout-modern .prayer-name { font-size: 1rem; margin-bottom: 0.3rem; }
        body.layout-modern .prayer-time { font-size: 1.3rem; }

        /* ============================================
           LAYOUT: Sidebar Right
           ============================================ */
        body.layout-sidebar_right .content-grid {
            grid-template-columns: 1fr 320px;
        }
        body.layout-sidebar_right .prayer-list { order: 2; }
        body.layout-sidebar_right .slide-container { order: 1; }
        body.layout-sidebar_right .prayer-item.active {
            transform: scale(1.05) translateX(-5px);
        }

        /* ============================================
           LAYOUT: Full Slider (Overlay)
           ============================================ */
        body.layout-full_slider .header {
            position: absolute;
            width: 100%;
            z-index: 20;
            background: linear-gradient(to bottom, rgba(0,0,0,0.85), transparent);
        }
        body.layout-full_slider .content-grid {
            display: block;
            padding: 0;
            height: 100vh;
            position: relative;
        }
        body.layout-full_slider .slide-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            border: none;
            border-radius: 0;
            z-index: 1;
            background: transparent;
        }
        body.layout-full_slider .slide {
            padding: 8rem 4rem 6rem;
        }
        body.layout-full_slider .prayer-list {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            flex-direction: row;
            width: auto;
            gap: 0;
            background: rgba(0,0,0,0.65);
            padding: 0.8rem 1.5rem;
            border-radius: 50px;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.15);
        }
        body.layout-full_slider .prayer-item {
            flex-direction: column;
            background: transparent;
            border: none;
            text-align: center;
            padding: 0.4rem 1rem;
            min-width: 90px;
            box-shadow: none;
            border-radius: 20px;
        }
        body.layout-full_slider .prayer-item.active {
            background: rgba(255,255,255,0.1);
            transform: none;
            box-shadow: none;
        }
        body.layout-full_slider .prayer-name { font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 0.15rem; }
        body.layout-full_slider .prayer-time { font-size: 1.2rem; }

        /* ============================================
           LAYOUT: Simple Minimalis
           ============================================ */
        body.layout-simple .header {
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 1.5rem 2rem;
        }
        body.layout-simple .clock-widget {
            margin-top: 0.5rem;
            text-align: center;
        }
        body.layout-simple .clock-time { font-size: 2.5rem; }
        body.layout-simple .clock-date { font-size: 1rem; }
        body.layout-simple .masjid-info h1 { font-size: 2rem; }
        body.layout-simple .content-grid {
            grid-template-columns: 280px 1fr;
            gap: 1.5rem;
        }
        body.layout-simple .prayer-item {
            padding: 0.8rem 1.2rem;
        }
        body.layout-simple .prayer-name { font-size: 1.2rem; }
        body.layout-simple .prayer-time { font-size: 1.3rem; }
        body.layout-simple .slide-title { font-size: 1.5rem; }
        body.layout-simple .slide-text { font-size: 1.4rem; }

        /* ============================================
           LAYOUT: Fokus Info Masjid
           ============================================ */
        body.layout-masjid_info .content-grid {
            grid-template-columns: 1fr 280px;
            gap: 1.5rem;
        }
        body.layout-masjid_info .slide-container { order: 1; }
        body.layout-masjid_info .prayer-list { order: 2; }
        body.layout-masjid_info .prayer-item {
            padding: 0.6rem 1rem;
        }
        body.layout-masjid_info .prayer-name { font-size: 1.1rem; }
        body.layout-masjid_info .prayer-time { font-size: 1.2rem; }
        body.layout-masjid_info .slide-text { font-size: 2rem; }
        body.layout-masjid_info .slide-title { font-size: 2.2rem; }

        /* ============================================
           LAYOUT: Jam Besar (Big Clock - Digital Style)
           ============================================ */
        body.layout-big_clock {
            background: radial-gradient(ellipse at top, #0f3d24 0%, #020f08 100%);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        body.layout-big_clock .bg-media { display: none; }

        /* -- Header: Nama Masjid (top) -- */
        body.layout-big_clock .header {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2vh 1rem 0;
            background: transparent;
            flex-shrink: 0;
        }
        body.layout-big_clock .masjid-info {
            text-align: center;
        }
        body.layout-big_clock .masjid-info h1 {
            font-family: 'Cinzel', serif;
            font-size: clamp(2rem, 4vw, 3.5rem);
            color: var(--gold);
            text-shadow: 0 2px 10px rgba(0,0,0,0.8), 0 0 20px rgba(255,193,7,0.3);
            letter-spacing: 3px;
            text-transform: uppercase;
            border-bottom: 3px solid var(--gold-dark);
            display: inline-block;
            padding-bottom: 0.3rem;
            margin: 0;
        }
        body.layout-big_clock .masjid-info p { display: none; }

        /* -- Clock Widget: Date above clock, clock big -- */
        body.layout-big_clock .clock-widget {
            text-align: center;
            width: 100%;
            margin-top: 1.5vh;
            order: 0;
        }
        body.layout-big_clock .clock-date {
            font-family: 'Outfit', sans-serif;
            font-size: clamp(1rem, 1.8vw, 1.5rem);
            color: rgba(255,255,255,0.8);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
            opacity: 1;
            margin-bottom: 1vh;
            order: -1;
        }
        body.layout-big_clock .clock-time {
            font-family: 'Orbitron', monospace;
            font-size: clamp(5rem, 10vw, 9rem);
            color: var(--led-red);
            background: #000;
            padding: 0.3rem 2rem;
            border-radius: 16px;
            border: 4px solid #444;
            box-shadow:
                inset 0 0 30px rgba(255,0,0,0.15),
                0 0 20px rgba(0,0,0,0.6),
                0 0 0 6px #1a1a1a;
            display: inline-block;
            text-shadow: 0 0 15px rgba(255,51,51,0.6);
            letter-spacing: 5px;
            line-height: 1.15;
        }

        /* -- Content Grid: holds prayer list -- */
        body.layout-big_clock .content-grid {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2vh 5vw;
            flex: 1;
            min-height: 0;
        }

        /* -- Prayer List: 3 columns for 5 items -- */
        body.layout-big_clock .prayer-list {
            position: relative;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.2rem 2rem;
            background: rgba(0, 30, 15, 0.6);
            padding: 3rem 2.5rem 2rem;
            border: 2px solid var(--gold-dark);
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 1000px;
        }
        body.layout-big_clock .prayer-list::before {
            content: "✦ JADWAL SHOLAT ✦";
            position: absolute;
            top: -0.9rem;
            left: 50%;
            transform: translateX(-50%);
            background: #041f10;
            color: var(--gold);
            padding: 0.15rem 1.5rem;
            font-family: 'Cinzel', serif;
            font-weight: bold;
            font-size: clamp(0.9rem, 1.3vw, 1.2rem);
            border: 2px solid var(--gold-dark);
            border-radius: 5px;
            white-space: nowrap;
        }

        /* -- Prayer Item -- */
        body.layout-big_clock .prayer-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            padding: 0.8rem 1.2rem;
            box-shadow: none;
            transition: background 0.3s;
        }
        body.layout-big_clock .prayer-item.active {
            transform: none;
            background: rgba(255,193,7,0.12);
            border: 2px solid var(--gold);
            box-shadow: 0 0 15px rgba(255,193,7,0.15);
        }
        body.layout-big_clock .prayer-name {
            font-size: clamp(1.1rem, 1.5vw, 1.5rem);
            color: var(--gold);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        body.layout-big_clock .prayer-time {
            font-family: 'Orbitron', monospace;
            font-size: clamp(1.4rem, 2vw, 2rem);
            color: var(--led-red);
            text-shadow: 0 0 5px rgba(255,50,50,0.4);
        }
        body.layout-big_clock .prayer-item#item-Syuruq { display: none; }
        body.layout-big_clock .slide-container { display: none; }

        /* -- Running Text for big_clock -- */
        body.layout-big_clock .running-text-container {
            background: rgba(0,0,0,0.9);
            border-top: 2px solid var(--gold-dark);
            color: var(--gold);
        }

    </style>
</head>
<body class="theme-{{ display_settings.tema|default:'default' }} layout-{{ display_settings.layout|default:'classic' }}">
    {% if display_settings.video_url %}
        <img src="https://images.unsplash.com/photo-1564121211835-e88c852648ab?q=80&w=2070&auto=format&fit=crop" class="bg-media" alt="Background">
    {% else %}
        <img src="https://images.unsplash.com/photo-1564121211835-e88c852648ab?q=80&w=2070&auto=format&fit=crop" class="bg-media" alt="Background">
    {% endif %}

    <div class="header">
        <div class="masjid-info">
            <h1>{{ profil.nama|default:"Masjid Al-Ikhlas" }}</h1>
            <p>{{ profil.alamat|default:"Jl. Kebnikan No. 1" }}</p>
        </div>
        <div class="clock-widget">
            <div class="clock-time" id="clock">00:00:00</div>
            <div class="clock-date" id="date">Senin, 1 Januari 2024</div>
            <div class="clock-hijri" id="hijri-date">☪ {% hijri_today_full %}</div>
        </div>
    </div>

    <div class="content-grid">
        <!-- Sidebar Jadwal Sholat -->
        <div class="prayer-list">
             <div class="prayer-item" id="item-Subuh">
                <span class="prayer-name">Subuh</span>
                <span class="prayer-time">{{ prayer_times.fajr|date:"H:i" }}</span>
            </div>
            <div class="prayer-item" id="item-Syuruq">
                <span class="prayer-name">Syuruq</span>
                <span class="prayer-time">{{ prayer_times.sunrise|date:"H:i" }}</span>
            </div>
            <div class="prayer-item" id="item-Dzuhur">
                <span class="prayer-name">Dzuhur</span>
                <span class="prayer-time">{{ prayer_times.dhuhr|date:"H:i" }}</span>
            </div>
            <div class="prayer-item" id="item-Ashar">
                <span class="prayer-name">Ashar</span>
                <span class="prayer-time">{{ prayer_times.asr|date:"H:i" }}</span>
            </div>
            <div class="prayer-item" id="item-Maghrib">
                <span class="prayer-name">Maghrib</span>
                <span class="prayer-time">{{ prayer_times.maghrib|date:"H:i" }}</span>
            </div>
            <div class="prayer-item" id="item-Isya">
                <span class="prayer-name">Isya</span>
                <span class="prayer-time">{{ prayer_times.isha|date:"H:i" }}</span>
            </div>
        </div>

        <!-- Main Slide Area -->
        <div class="slide-container">
            {% for slide in slides %}
            <div class="slide" data-duration="{{ slide.durasi|default:10 }}">
                {% if slide.judul %}<div class="slide-title">{{ slide.judul }}</div>{% endif %}

                {% if slide.tipe == 'teks' %}
                    <div class="slide-content-center">
                        <div class="slide-text">{{ slide.konten_teks|linebreaks }}</div>
                    </div>

                {% elif slide.tipe == 'gambar' %}
                    <div class="slide-content-center slide-image">
                        {% if slide.gambar %}
                        <img src="{{ slide.gambar.url }}" alt="{{ slide.judul }}">
                        {% endif %}
                        {% if slide.konten_teks %}
                        <p style="margin-top:1rem">{{ slide.konten_teks }}</p>
                        {% endif %}
                    </div>

                {% elif slide.tipe == 'kas' %}
                    <div class="slide-content-center">
                         <div class="finance-box">
                             <h3 style="color:rgba(255,255,255,0.7)">SALDO KAS SAAT INI</h3>
                             <div class="finance-amount">Rp {{ saldo_akhir|rupiah }}</div>
                             <p style="color:rgba(255,255,255,0.7)">Laporan Keuangan Masjid</p>
                         </div>
                    </div>

                {% elif slide.tipe == 'kegiatan' %}
                    <div style="width:100%;padding:1rem">
                        {% for keg in kegiatan_list %}
                        <div class="list-item">
                            <div class="list-date">
                                <div class="day">{{ keg.tanggal|date:"d" }}</div>
                                <div class="month">{{ keg.tanggal|date:"M" }}</div>
                            </div>
                            <div>
                                <h3 style="margin:0;color:var(--accent)">{{ keg.judul }}</h3>
                                <p style="margin:0;opacity:0.75"><i class="bi bi-clock"></i> {{ keg.waktu|time:"H:i" }} - {{ keg.tempat }}</p>
                            </div>
                        </div>
                        {% empty %}
                        <div class="slide-content-center"><p>Belum ada kegiatan mendatang.</p></div>
                        {% endfor %}
                    </div>

                {% elif slide.tipe == 'berita' %}
                     <div style="width:100%;padding:1rem">
                        {% for item in berita_list %}
                        <div class="list-item">
                            {% if item.gambar %}
                            <img src="{{ item.gambar.url }}" style="width:80px;height:80px;object-fit:cover;border-radius:8px">
                            {% else %}
                            <div style="width:80px;height:80px;background:#333;border-radius:8px;display:flex;align-items:center;justify-content:center"><i class="bi bi-newspaper" style="font-size:1.5rem"></i></div>
                            {% endif %}
                            <div>
                                <h3 style="margin:0;color:#fff">{{ item.judul }}</h3>
                                <span style="background:var(--primary);padding:2px 8px;border-radius:4px;font-size:0.8rem;margin-top:4px;display:inline-block">{{ item.kategori.nama }}</span>
                                <p style="margin:0;opacity:0.75;font-size:0.85rem;margin-top:4px">{{ item.created_at|date:"d M Y" }}</p>
                            </div>
                        </div>
                        {% empty %}
                         <div class="slide-content-center"><p>Belum ada berita terbaru.</p></div>
                        {% endfor %}
                     </div>

                {% elif slide.tipe == 'donasi' %}
                    <div class="slide-content-center">
                        <div style="background:rgba(255,255,255,0.05); padding:3rem; border-radius:20px; border:1px solid rgba(255,255,255,0.1); display:flex; gap:3rem; align-items:center; max-width:90%;">
                             {% if site_setting.qris_image %}
                             <div style="text-align:center; background:#fff; padding:1.5rem; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.3);">
                                 <img src="{{ site_setting.qris_image.url }}" style="height:400px; width:auto; object-fit:contain;">
                                 <p style="color:#000; margin:1rem 0 0; font-weight:bold; font-size:1.5rem;">SCAN QRIS</p>
                             </div>
                             {% endif %}
                             
                             <div style="text-align:left; flex:1;">
                                 <h2 style="font-size:3.5rem; color:var(--accent); margin:0 0 1.5rem; line-height:1.2;">{{ slide.judul|default:"Salurkan Infaq & Sedekah" }}</h2>
                                 <div style="font-size:2rem; line-height:1.6; margin-bottom:2rem;">
                                     {{ site_setting.donasi_teks|default:"Mari makmurkan masjid dengan harta terbaik kita." }}
                                 </div>
                                 {% if site_setting.rekening_info %}
                                 <div style="background:rgba(26, 107, 60, 0.8); padding:2rem; border-radius:16px; font-size:1.8rem; border-left:8px solid var(--accent);">
                                     {{ site_setting.rekening_info|linebreaksbr }}
                                 </div>
                                 {% endif %}
                             </div>
                        </div>
                    </div>

                {% else %}
                    <div class="slide-content-center">
                        <div class="slide-text">{{ slide.konten_teks|linebreaks }}</div>
                    </div>
                {% endif %}
            </div>
            {% empty %}
            <!-- Default Slide if No Slides Configured -->
            <div class="slide active" data-duration="9999">
                <div class="slide-content-center">
                    <div>
                        <h2>Menuju Waktu <span id="next-prayer-name">...</span></h2>
                        <div id="countdown" style="font-size:6rem;font-weight:bold;color:var(--accent)">--:--:--</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="running-text-container">
        <div class="running-text">
            {{ display_settings.running_text }}
        </div>
    </div>

    <script>
        // Clock & Prayer Time Logic
        const prayerTimes = {
            'Subuh': new Date("{{ prayer_times.fajr.isoformat }}"),
            'Syuruq': new Date("{{ prayer_times.sunrise.isoformat }}"),
            'Dzuhur': new Date("{{ prayer_times.dhuhr.isoformat }}"),
            'Ashar': new Date("{{ prayer_times.asr.isoformat }}"),
            'Maghrib': new Date("{{ prayer_times.maghrib.isoformat }}"),
            'Isya': new Date("{{ prayer_times.isha.isoformat }}")
        };

        // Notification Logic
        const playedNotifications = {};
        const notifAudio = new Audio();

        {% if display_settings.custom_notification %}
        notifAudio.src = "{{ display_settings.custom_notification.url }}";
        {% elif display_settings.sholat_notification %}
        notifAudio.src = "{% static 'audio/' %}{{ display_settings.sholat_notification }}";
        {% endif %}

        function playNotification() {
            if (notifAudio.src) {
                notifAudio.play().catch(function(e) {
                    console.log("Audio play blocked by browser:", e);
                });
            }
        }

        // ── Hijri date computation (client-side) ──
        const HIJRI_MONTHS = [
            '', 'Muharram', 'Safar', "Rabi'ul Awal", "Rabi'ul Akhir",
            'Jumadil Awal', 'Jumadil Akhir', 'Rajab', "Sya'ban",
            'Ramadan', 'Syawal', "Dzulqa'dah", 'Dzulhijjah'
        ];
        const HARI_ID = ['Ahad', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];

        function gregorianToHijri(year, month, day) {
            // Kuwaiti algorithm for Gregorian to Hijri conversion
            var m = month;
            var y = year;
            if (m < 3) { y -= 1; m += 12; }
            var a = Math.floor(y / 100);
            var b = 2 - a + Math.floor(a / 4);
            if (y < 1583) b = 0;
            if (y === 1582) {
                if (m > 10) b = -10;
                if (m === 10 && day > 14) b = -10;
            }
            var jd = Math.floor(365.25 * (y + 4716)) + Math.floor(30.6001 * (m + 1)) + day + b - 1524;
            b = 0;
            if (jd > 2299160) {
                a = Math.floor((jd - 1867216.25) / 36524.25);
                b = 1 + a - Math.floor(a / 4);
            }
            var bb = jd + b + 1524;
            var cc = Math.floor((bb - 122.1) / 365.25);
            var dd = Math.floor(365.25 * cc);
            var ee = Math.floor((bb - dd) / 30.6001);
            day = bb - dd - Math.floor(30.6001 * ee);
            if (ee === 14 || ee === 15) month = ee - 13; else month = ee - 1;
            if (month > 2) year = cc - 4716; else year = cc - 4715;
            // Gregorian to Julian Day Number done, now to Hijri
            var wd = (jd + 1) % 7; // 0=Sun, 1=Mon... 6=Sat
            var l = jd - 1948440 + 10632;
            var n = Math.floor((l - 1) / 10631);
            l = l - 10631 * n + 354;
            var j = Math.floor((10985 - l) / 5316) * Math.floor((50 * l) / 17719) + Math.floor(l / 5670) * Math.floor((43 * l) / 15238);
            l = l - Math.floor((30 - j) / 15) * Math.floor((17719 * j) / 50) - Math.floor(j / 16) * Math.floor((15238 * j) / 43) + 29;
            var hm = Math.floor((24 * l) / 709);
            var hd = l - Math.floor((709 * hm) / 24);
            var hy = 30 * n + j - 30;
            return { day: hd, month: hm, year: hy, weekday: wd };
        }

        function getHijriString(dt) {
            var h = gregorianToHijri(dt.getFullYear(), dt.getMonth() + 1, dt.getDate());
            var dayName = HARI_ID[dt.getDay()];
            var monthName = HIJRI_MONTHS[h.month] || h.month;
            return '☪ ' + dayName + ', ' + h.day + ' ' + monthName + ' ' + h.year + ' H';
        }

        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('id-ID', { hour12: false });
            const dateString = now.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

            document.getElementById('clock').innerText = timeString;
            document.getElementById('date').innerText = dateString;
            document.getElementById('hijri-date').innerText = getHijriString(now);

            updateNextPrayer(now);
        }

        function updateNextPrayer(now) {
            let nextPrayer = null;
            let nextTime = null;
            let minDiff = Infinity;

            for (const [name, time] of Object.entries(prayerTimes)) {
                const diff = new Date(time) - now;
                if (diff > 0 && diff < minDiff) {
                    minDiff = diff;
                    nextPrayer = name;
                    nextTime = new Date(time);
                }
            }

            if (!nextPrayer && prayerTimes['Subuh']) {
                nextPrayer = 'Subuh';
                const todaySubuh = new Date(prayerTimes['Subuh']);
                nextTime = new Date(todaySubuh.getTime() + 24 * 60 * 60 * 1000);
            }

            if (nextPrayer && nextTime) {
                document.querySelectorAll('.prayer-item').forEach(function(el) { el.classList.remove('active'); });
                const activeEl = document.getElementById('item-' + nextPrayer);
                if (activeEl) activeEl.classList.add('active');

                const countdownEl = document.getElementById('countdown');
                const nextNameEl = document.getElementById('next-prayer-name');

                if (countdownEl && nextNameEl) {
                    nextNameEl.innerText = nextPrayer;
                    const diffMs = nextTime - now;

                    if (diffMs > 0) {
                        const hours = Math.floor(diffMs / (1000 * 60 * 60));
                        const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);
                        countdownEl.innerText =
                            String(hours).padStart(2, '0') + ':' +
                            String(minutes).padStart(2, '0') + ':' +
                            String(seconds).padStart(2, '0');

                        if (diffMs < 1000 && !playedNotifications[nextPrayer]) {
                            playNotification();
                            playedNotifications[nextPrayer] = true;
                        }
                    } else {
                        countdownEl.innerText = "00:00:00";
                        if (!playedNotifications[nextPrayer] && diffMs > -5000) {
                            playNotification();
                            playedNotifications[nextPrayer] = true;
                        }
                    }
                }
            }
        }

        setInterval(updateClock, 1000);
        updateClock();

        // Slideshow Logic
        const slides = document.querySelectorAll('.slide');
        if (slides.length > 0) {
            let currentSlideIndex = 0;

            function showSlide(index) {
                slides.forEach(function(slide, i) {
                    if (i === index) {
                        slide.classList.add('active');
                    } else {
                        slide.classList.remove('active');
                    }
                });
                const duration = parseInt(slides[index].getAttribute('data-duration')) || 10;
                setTimeout(nextSlide, duration * 1000);
            }

            function nextSlide() {
                currentSlideIndex = (currentSlideIndex + 1) % slides.length;
                showSlide(currentSlideIndex);
            }

            showSlide(0);
        }
    </script>

    <!-- ============================================
         OVERLAY DISPLAY CONTROLS
         ============================================ -->
    <style>
        .display-controls-trigger {
            position: fixed;
            bottom: 16px;
            right: 16px;
            z-index: 9999;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.15);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }
        .display-controls-trigger:hover,
        .display-controls-trigger:focus {
            background: rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.9);
            transform: scale(1.1);
        }
        .display-controls-trigger.active {
            background: rgba(255,255,255,0.25);
            color: #fff;
            transform: scale(1.1) rotate(90deg);
        }

        .display-controls-panel {
            position: fixed;
            bottom: 64px;
            right: 16px;
            z-index: 9998;
            width: 280px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 12px;
            padding: 16px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px) scale(0.95);
            transition: all 0.25s ease;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        .display-controls-panel.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .dc-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.4);
            margin-bottom: 6px;
            font-weight: 600;
        }
        .dc-select {
            width: 100%;
            padding: 6px 10px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-family: 'Outfit', sans-serif;
            outline: none;
            cursor: pointer;
            transition: border-color 0.2s;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M8 10.5l-5-5h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }
        .dc-select:hover, .dc-select:focus {
            border-color: rgba(255,255,255,0.35);
        }
        .dc-select option {
            background: #1e293b;
            color: #fff;
        }

        .dc-nav-buttons {
            display: flex;
            gap: 8px;
            margin-top: 4px;
        }
        .dc-nav-btn {
            flex: 1;
            padding: 7px 8px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 8px;
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        .dc-nav-btn:hover {
            background: rgba(255,255,255,0.15);
            color: #fff;
            border-color: rgba(255,255,255,0.25);
        }
        .dc-nav-btn.disabled {
            opacity: 0.3;
            pointer-events: none;
        }
        .dc-divider {
            height: 1px;
            background: rgba(255,255,255,0.08);
            margin: 10px 0;
        }
        .dc-current-name {
            font-size: 13px;
            font-weight: 600;
            color: rgba(255,255,255,0.85);
            text-align: center;
            margin-bottom: 2px;
        }
    </style>

    <!-- Trigger Button -->
    <button class="display-controls-trigger" id="dcTrigger" title="Display Controls">
        <i class="bi bi-gear-fill"></i>
    </button>

    <!-- Controls Panel -->
    <div class="display-controls-panel" id="dcPanel">
        <div class="dc-current-name">{{ display_settings.nama }}</div>
        <div class="dc-divider"></div>

        <!-- Theme Selector -->
        <div class="dc-label">Tema</div>
        <select class="dc-select" id="dcTheme">
            {% for val, label in theme_choices %}
            <option value="{{ val }}" {% if display_settings.tema == val %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>

        <div style="height: 10px;"></div>

        <!-- Layout Selector -->
        <div class="dc-label">Layout</div>
        <select class="dc-select" id="dcLayout">
            {% for val, label in layout_choices %}
            <option value="{{ val }}" {% if display_settings.layout == val %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>

        <div class="dc-divider"></div>

        <!-- Prev / Next Display -->
        <div class="dc-label">Navigasi Display</div>
        <div class="dc-nav-buttons">
            {% if prev_display %}
            <a href="{% url 'display:detail' pk=prev_display.pk %}" class="dc-nav-btn">
                <i class="bi bi-chevron-left"></i> {{ prev_display.nama|truncatechars:12 }}
            </a>
            {% else %}
            <span class="dc-nav-btn disabled"><i class="bi bi-chevron-left"></i> —</span>
            {% endif %}

            {% if next_display %}
            <a href="{% url 'display:detail' pk=next_display.pk %}" class="dc-nav-btn">
                {{ next_display.nama|truncatechars:12 }} <i class="bi bi-chevron-right"></i>
            </a>
            {% else %}
            <span class="dc-nav-btn disabled">— <i class="bi bi-chevron-right"></i></span>
            {% endif %}
        </div>
    </div>

    <script>
        // Toggle controls panel
        (function() {
            var trigger = document.getElementById('dcTrigger');
            var panel = document.getElementById('dcPanel');

            trigger.addEventListener('click', function() {
                var isOpen = panel.classList.contains('show');
                panel.classList.toggle('show');
                trigger.classList.toggle('active');
            });

            // Close on outside click
            document.addEventListener('click', function(e) {
                if (!panel.contains(e.target) && !trigger.contains(e.target)) {
                    panel.classList.remove('show');
                    trigger.classList.remove('active');
                }
            });

            // Theme / Layout change → AJAX POST → reload
            var displayPk = {{ display_settings.pk }};
            var apiUrl = '/display/' + displayPk + '/update/';

            document.getElementById('dcTheme').addEventListener('change', function() {
                var fd = new FormData();
                fd.append('tema', this.value);
                fetch(apiUrl, {method: 'POST', body: fd}).then(function() {
                    location.reload();
                });
            });

            document.getElementById('dcLayout').addEventListener('change', function() {
                var fd = new FormData();
                fd.append('layout', this.value);
                fetch(apiUrl, {method: 'POST', body: fd}).then(function() {
                    location.reload();
                });
            });
        })();
    </script>
</body>
</html>
